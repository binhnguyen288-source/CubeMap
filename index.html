<!DOCTYPE html>
<html>
    <body>
        <input type="file" id="inputFile">
        <script src="./viewer.js"></script>
        <canvas id="viewer" width="1280" height="720"></canvas>
        <a id="download" hidden>Download</a>
        <script defer>
            Module.onRuntimeInitialized = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext("2d");
                const image = document.createElement('img');
                const viewer = document.getElementById('viewer');
                const ctxViewer = viewer.getContext("2d");


                function selectedFile(ev) {


                    const objectURL = URL.createObjectURL(ev.files[0]);
                    image.onload = () => {
                        URL.revokeObjectURL(objectURL);

                        canvas.width = image.naturalWidth;
                        canvas.height = image.naturalHeight;
                        ctx.drawImage(image, 0, 0);
                        const image_data = ctx.getImageData(0, 0, canvas.width, canvas.height);

                        const nCubeSide = canvas.width / 4;

                        const srcPtr = Module._malloc(4 * canvas.width * canvas.height);
                        const dstPtr = Module._malloc(4 * nCubeSide * 6 * nCubeSide);

                        Module.HEAPU8.set(image_data.data, srcPtr);

                        Module._jsCubeMap(srcPtr, dstPtr, canvas.width, canvas.height);

                        // canvas.width = nCubeSide;
                        // canvas.height = 6 * nCubeSide;

                        // const dstImg = new Uint8ClampedArray(Module.HEAPU8.subarray(dstPtr, dstPtr + 4 * canvas.width * canvas.height));
                        // const dstImageData = new ImageData(dstImg, canvas.width);

                        // ctx.putImageData(dstImageData, 0, 0);

                        Module._free(srcPtr);
                        Module._free(dstPtr);
                        
                        // canvas.toBlob((blob) => {
                        //     document.getElementById("download").download = "Result.jpg";
                        //     document.getElementById("download").href = URL.createObjectURL(blob);
                        //     document.getElementById("download").click();
                        // }, "image/jpeg", 1);


                        
                        let theta0 = 0;
                        let phi0 = 0;
                        let hfov = Math.PI * 100 / 180;

                        const viewerData = Module._malloc(4 * viewer.width * viewer.height);

                        const dstImageData = new ImageData(viewer.width, viewer.height);
                        const renderFrame = () => {
                            Module._viewerQuery(viewerData, viewer.width, viewer.height, theta0, phi0, hfov);
                            dstImageData.data.set(Module.HEAPU8.subarray(viewerData, viewerData + 4 * viewer.width * viewer.height));
                            ctxViewer.putImageData(dstImageData, 0, 0);
                        };

                        renderFrame();


                                
                                
                        let isClicking = false;
                        let prevPosition = null;

                        const btnDownHandler = (ev) => {
                            isClicking = true;

                            const boundingRect = viewer.getBoundingClientRect();

                            prevPosition = {
                                x: ev.clientX - boundingRect.left,
                                y: ev.clientY - boundingRect.top
                            };

                        };

                        const btnUpHandler = () => {
                            isClicking = false;
                            prevPosition = null;
                        }

                        const btnMoveHandler = (ev) => {
                            if (!isClicking) return;

                            const boundingRect = viewer.getBoundingClientRect();

                            const curPosition = {
                                x: ev.clientX - boundingRect.left,
                                y: ev.clientY - boundingRect.top
                            };

                            const dx = curPosition.x - prevPosition.x;
                            const dy = curPosition.y - prevPosition.y;

                            theta0 += dx * 0.01;
                            phi0 -= dy * 0.01;

                            renderFrame();


                            prevPosition = curPosition;

                        }

                        viewer.onmousedown = btnDownHandler;
                        viewer.onmousemove = btnMoveHandler;
                        viewer.onmouseup = btnUpHandler;
                        viewer.onmouseout = btnUpHandler;
                        viewer.onwheel = ev => {
                            ev.preventDefault();
                            if (ev.deltaY > 0 && hfov < Math.PI * 150 / 180) hfov += 0.1;
                            if (ev.deltaY < 0 && hfov > 0.1) hfov -= 0.1;
                            
                            renderFrame();
                        }
                      


                        viewer.ontouchstart = ev => {
                            ev.preventDefault();
                            btnDownHandler({
                                clientX: ev.touches[0].clientX,
                                clientY: ev.touches[0].clientY
                            });
                        }
                        viewer.ontouchmove = ev => {
                            ev.preventDefault();
                            btnMoveHandler({
                                clientX: ev.touches[0].clientX,
                                clientY: ev.touches[0].clientY
                            });
                        };
                        viewer.ontouchend = btnUpHandler;
                        viewer.ontouchcancel = btnUpHandler;

                    }
                    image.src = objectURL;
                }
                const inputField = document.getElementById("inputFile");

                inputField.onchange = () => {
                    inputField.setAttribute('hidden', '');
                    selectedFile(inputField)
                };


            }

            
        </script>
    </body>
</html>